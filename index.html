<script>
  // ===================== CONFIG =====================
  const firebaseConfig = {
    apiKey: "AIzaSyBzgChouE4W25XnD-vFybJrKVN9yl3R0IQ",
    authDomain: "ferroportluannogueira.firebaseapp.com",
    projectId: "ferroportluannogueira",
    storageBucket: "ferroportluannogueira.firebasestorage.app",
    messagingSenderId: "531699539518",
    appId: "1:531699539518:web:6e32a169d9110f70b9fb6f",
    measurementId: "G-61BRVCSHD7"
  };

  const CONTRATOS = [
    { value: "ferroport",  label: "Ferroport" },
    { value: "pta-inveco", label: "PTA INVECO" }
  ];

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  let LISTA = [];
  let NOMES = [];
  let selecaoDiaria = [];

  let PTA_LISTA = [];
  let mostrarTodosPTA = false;
  const LIMITE_PTA = 6;

  let mostrarTodosRegistros = false;
  const LIMITE_REGISTROS = 5;

  let mostrarTodosMes = false;
  const LIMITE_MES = 6;

  const KEY_CONTRATO = "contrato_atual";
  let contratoAtual = localStorage.getItem(KEY_CONTRATO) || "ferroport";

  let allowedContracts = [];
  let isAdmin = false;

  let refDiarios = null;
  let refNomes = null;
  let refPTA = null;

  let unsubDiarios = null;
  let unsubNomes = null;
  let unsubPTA = null;

  // ===================== TEMA =====================
  const KEY_TEMA = "tema_site";
  function aplicarTema(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(KEY_TEMA, theme);

    const txt = theme === "dark" ? "‚òÄÔ∏è Tema" : "üåô Tema";
    const btn = document.getElementById("btnTema");
    const btnLogin = document.getElementById("btnTemaLogin");
    if(btn) btn.textContent = txt;
    if(btnLogin) btnLogin.textContent = txt;

    try{ setTimeout(() => atualizarPainel(), 10); }catch(_){}
  }
  function toggleTema(){
    const atual = document.documentElement.getAttribute("data-theme") || "light";
    aplicarTema(atual === "dark" ? "light" : "dark");
  }
  window.toggleTema = toggleTema;

  window.addEventListener("DOMContentLoaded", () => {
    const salvo = localStorage.getItem(KEY_TEMA) || "light";
    aplicarTema(salvo);
  });

  function toggleSenha(inputId, btn){
    const input = document.getElementById(inputId);
    if(!input || !btn) return;

    const mostrando = input.type === "text";
    input.type = mostrando ? "password" : "text";

    const closed = btn.querySelector(".cam-closed");
    const open = btn.querySelector(".cam-open");
    if(closed && open){
      closed.style.display = mostrando ? "inline-flex" : "none";
      open.style.display = mostrando ? "none" : "inline-flex";
    }
  }
  window.toggleSenha = toggleSenha;

  // ===================== HELPERS =====================
  function formatarDataBR(dataISO){
    if(!dataISO) return "";
    const [y,m,d] = dataISO.split("-");
    return `${d}/${m}/${y}`;
  }
  function hojeISO(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function agoraBR(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function getMesAnoSelecionado(){
    const v = document.getElementById("mesAno").value;
    if(!v) return null;
    const [y,m] = v.split("-");
    return { y, m };
  }
  function idSeguro(str){
    return String(str || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g,"-")
      .replace(/[^a-z0-9\-]/g,"")
      .slice(0,80);
  }
  function nomeContratoBonito(slug){
    return ({ "ferroport":"Ferroport", "pta-inveco":"PTA INVECO" }[slug] || slug);
  }
  function inMesAno(dataISO, y, m){
    if(!dataISO) return false;
    return dataISO.startsWith(`${y}-${m}-`);
  }

  // ===================== RANKING + GR√ÅFICO (CANVAS) =====================
  function contarDiasPorTecnico(itensMes){
    const map = new Map();
    itensMes.forEach(item => {
      (item.pessoas || []).forEach(nome => {
        map.set(nome, (map.get(nome) || 0) + 1);
      });
    });
    return [...map.entries()]
      .map(([nome, dias]) => ({ nome, dias }))
      .sort((a,b) => b.dias - a.dias || a.nome.localeCompare(b.nome, "pt-BR"));
  }

  function desenharGraficoTop10(canvasId, data){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;

    // Se o canvas estiver oculto/sem tamanho, n√£o desenha ainda
    const w = canvas.clientWidth || 0;
    const h = canvas.clientHeight || 0;
    if(w < 50 || h < 50) return;

    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);

    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);

    if(!data || data.length === 0){
      ctx.font = "14px Arial";
      ctx.fillStyle = "#888";
      ctx.fillText("Sem dados no m√™s selecionado.", 12, 24);
      return;
    }

    const top = data.slice(0,10);
    const max = Math.max(...top.map(x => x.dias), 1);

    const padL = 150;
    const padR = 18;
    const padT = 18;
    const padB = 18;

    const plotW = w - padL - padR;
    const rowH = Math.max(24, Math.floor((h - padT - padB) / top.length));
    const barH = Math.floor(rowH * 0.55);

    const styles = getComputedStyle(document.documentElement);
    const text = styles.getPropertyValue("--text").trim() || "#111";
    const muted = styles.getPropertyValue("--muted").trim() || "#666";
    const border = styles.getPropertyValue("--border").trim() || "#ddd";
    const bar = styles.getPropertyValue("--digital-red").trim() || "#CB3344";

    // Linha vertical
    ctx.strokeStyle = border;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, h - padB);
    ctx.stroke();

    ctx.font = "12px Arial";
    ctx.textBaseline = "middle";

    top.forEach((item, i) => {
      const y = padT + i * rowH + rowH/2;

      // Nome
      ctx.fillStyle = muted;
      const nome = item.nome.length > 22 ? item.nome.slice(0,22) + "‚Ä¶" : item.nome;
      ctx.fillText(nome, 12, y);

      // Barra
      const bw = Math.max(2, (item.dias / max) * plotW);
      const x0 = padL;
      const y0 = Math.round(y - barH/2);

      ctx.fillStyle = bar;
      ctx.fillRect(x0, y0, bw, barH);

      // Valor
      ctx.fillStyle = text;
      ctx.fillText(String(item.dias), x0 + bw + 8, y);
    });
  }

  // ===================== PERMISS√ïES =====================
  async function carregarPermissoesUsuario(user){
    const snap = await db.collection("users").doc(user.uid).get();
    if(!snap.exists){
      allowedContracts = [];
      isAdmin = false;
      return;
    }
    const data = snap.data() || {};
    allowedContracts = Array.isArray(data.allowedContracts) ? data.allowedContracts : [];
    isAdmin = String(data.role || "").toLowerCase() === "gestor";
  }

  function montarSelectContratos(){
    const sel = document.getElementById("contratoSelect");
    if(!sel) return;

    sel.innerHTML = "";

    if(!allowedContracts.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sem acesso";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }

    sel.disabled = false;

    CONTRATOS
      .filter(c => allowedContracts.includes(c.value))
      .forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.value;
        opt.textContent = c.label;
        sel.appendChild(opt);
      });

    if(!allowedContracts.includes(contratoAtual)){
      contratoAtual = allowedContracts[0];
      localStorage.setItem(KEY_CONTRATO, contratoAtual);
    }

    sel.value = contratoAtual;
  }

  // ===================== REFS / REALTIME =====================
  function setRefsContrato(){
    refDiarios = db.collection("contratos").doc(contratoAtual).collection("diarios");
    refNomes   = db.collection("contratos").doc(contratoAtual).collection("nomes");
    refPTA     = db.collection("contratos").doc(contratoAtual).collection("ptauso");
  }

  function desligarRealtime(){
    if(typeof unsubDiarios === "function") unsubDiarios();
    if(typeof unsubNomes === "function") unsubNomes();
    if(typeof unsubPTA === "function") unsubPTA();
    unsubDiarios = unsubNomes = unsubPTA = null;
  }

  function ligarRealtime(){
    desligarRealtime();

    unsubDiarios = refDiarios.onSnapshot(
      (snap) => {
        LISTA = snap.docs.map(d => d.data());
        carregarDiario();
        atualizarPainel();
      },
      (err) => {
        console.error("Erro di√°rios:", err);
        alert("Sem permiss√£o para ler/salvar DI√ÅRIOS.\n\n" + (err?.message || err));
      }
    );

    unsubNomes = refNomes.onSnapshot(
      (snap) => {
        NOMES = snap.docs.map(d => (d.data()||{}).nome).filter(Boolean).sort((a,b) => a.localeCompare(b, "pt-BR"));
        renderChipsDiario();
      },
      (err) => {
        console.error("Erro nomes:", err);
        alert("Sem permiss√£o para ler/salvar NOMES.\n\n" + (err?.message || err));
      }
    );

    unsubPTA = refPTA.onSnapshot(
      (snap) => {
        PTA_LISTA = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||"") || (b.createdAt||0)-(a.createdAt||0));
        carregarPTA();
        atualizarPainel();
      },
      (err) => {
        console.error("Erro PTA:", err);
      }
    );
  }

  function mostrarBlocosContrato(){
    const isPTA = contratoAtual === "pta-inveco";

    document.getElementById("blocoPTA").style.display = isPTA ? "block" : "none";
    document.getElementById("blocoFerroport").style.display = isPTA ? "none" : "block";

    document.getElementById("cardPresenca").style.display = isPTA ? "none" : "block";
    document.getElementById("cardListaFerroport").style.display = isPTA ? "none" : "block";

    document.getElementById("printPTA").style.display = isPTA ? "block" : "none";
    document.getElementById("printFerroport").style.display = isPTA ? "none" : "block";
  }

  function setContrato(novo){
    if(!allowedContracts.includes(novo)){
      alert("Voc√™ n√£o tem permiss√£o para acessar este contrato.");
      const sel = document.getElementById("contratoSelect");
      if(sel) sel.value = contratoAtual;
      return;
    }

    contratoAtual = novo;
    localStorage.setItem(KEY_CONTRATO, contratoAtual);

    setRefsContrato();
    ligarRealtime();

    selecaoDiaria = [];
    renderChipsDiario();
    limparDiario(true);

    mostrarTodosMes = false;
    mostrarTodosRegistros = false;
    mostrarTodosPTA = false;

    mostrarBlocosContrato();
    atualizarPainel();
  }

  // ===================== AUTH =====================
  async function login(){
    const email = document.getElementById("loginEmail").value.trim();
    const senha = document.getElementById("loginSenha").value.trim();
    const msg = document.getElementById("loginMsg");
    const status = document.getElementById("loginStatus");
    const btn = document.getElementById("btnEntrar");

    msg.textContent = "";
    status.style.display = "flex";
    btn.disabled = true;

    try{
      await auth.signInWithEmailAndPassword(email, senha);
    }catch(e){
      msg.textContent = "Falha no login: " + (e?.code || e?.message || e);
      status.style.display = "none";
      btn.disabled = false;
    }
  }
  window.login = login;

  async function esqueciSenha(){
    const email = document.getElementById("loginEmail").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.textContent = "";

    if(!email){
      msg.textContent = "Digite seu e-mail para receber o link de redefini√ß√£o.";
      return;
    }

    try{
      await auth.sendPasswordResetEmail(email);
      msg.textContent = "Pronto! Enviamos um e-mail para redefinir sua senha.";
    }catch(e){
      msg.textContent = "N√£o foi poss√≠vel enviar: " + (e?.code || e?.message || e);
    }
  }
  window.esqueciSenha = esqueciSenha;

  async function logout(){ await auth.signOut(); }
  window.logout = logout;

  function mostrarApp(logado){
    document.getElementById("loginBox").style.display = logado ? "none" : "flex";
    document.getElementById("appRoot").style.display = logado ? "block" : "none";
  }

  function aplicarPermissoesUI(){
    const pill = document.getElementById("rolePill");
    const permMsg = document.getElementById("permMsg");
    const btnApagarTudo = document.getElementById("btnApagarTudo");

    pill.textContent = isAdmin ? "Gestor" : "T√©cnico";
    pill.classList.toggle("admin", isAdmin);

    if(btnApagarTudo) btnApagarTudo.style.display = isAdmin ? "inline-block" : "none";
    if(permMsg) permMsg.style.display = isAdmin ? "none" : "block";
  }

  // ===================== CHIPS =====================
  function renderChipsDiario(){
    const wrap = document.getElementById("chipsDiario");
    if(!wrap) return;
    wrap.innerHTML = "";

    NOMES.forEach(nome => {
      const box = document.createElement("div");
      box.className = "chip-box";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
      btn.innerText = nome;

      btn.onclick = () => {
        selecaoDiaria = selecaoDiaria.includes(nome)
          ? selecaoDiaria.filter(n => n !== nome)
          : [...selecaoDiaria, nome];
        renderChipsDiario();
      };

      const remover = document.createElement("span");
      remover.className = "remove";
      remover.title = "Excluir nome (gestor)";
      remover.innerText = "‚úñ";
      remover.style.display = isAdmin ? "inline-flex" : "none";
      remover.onclick = (e) => { e.stopPropagation(); excluirNome(nome); };

      box.appendChild(btn);
      box.appendChild(remover);
      wrap.appendChild(box);
    });
  }
  window.renderChipsDiario = renderChipsDiario;

  async function adicionarNome(){
    try{
      const input = document.getElementById("novoNome");
      const nome = input.value.trim();
      if(!nome) return alert("Digite um nome.");

      const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
      if(existe) return alert("Esse nome j√° existe.");

      await refNomes.doc(idSeguro(nome)).set({ nome });
      input.value = "";
    }catch(e){
      console.error(e);
      alert("Erro ao adicionar nome.\n\ncode: " + (e?.code || "‚Äî") + "\nmessage: " + (e?.message || e));
    }
  }
  window.adicionarNome = adicionarNome;

  async function excluirNome(nome){
    if(!isAdmin) return alert("Somente gestor pode excluir nomes.");
    if(!confirm(`Deseja excluir "${nome}"?`)) return;
    await refNomes.doc(idSeguro(nome)).delete();
    selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
  }

  // ===================== DI√ÅRIOS =====================
  async function salvarDiario(){
    try{
      const data = document.getElementById("dataDia").value;
      if(!data) return alert("Selecione a data.");
      if(selecaoDiaria.length === 0) return alert("Selecione pelo menos uma pessoa.");

      const item = { dataISO: data, dataBR: formatarDataBR(data), pessoas: [...selecaoDiaria] };
      await refDiarios.doc(data).set(item);

      alert("Dia salvo com sucesso!");
      limparDiario();
    }catch(e){
      console.error(e);
      alert("Erro ao salvar o dia.\n\ncode: " + (e?.code || "‚Äî") + "\nmessage: " + (e?.message || e));
    }
  }
  window.salvarDiario = salvarDiario;

  function limparDiario(silencioso=false){
    const dataDia = document.getElementById("dataDia");
    if(dataDia) dataDia.value = hojeISO();
    selecaoDiaria = [];
    renderChipsDiario();
    if(!silencioso){
      const novoNome = document.getElementById("novoNome");
      if(novoNome) novoNome.value = "";
    }
  }
  window.limparDiario = limparDiario;

  function carregarDiario(){
    const tbody = document.getElementById("tabelaDiario");
    if(!tbody) return;

    tbody.innerHTML = "";

    const dados = [...LISTA].sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));
    const visiveis = mostrarTodosRegistros ? dados : dados.slice(0, LIMITE_REGISTROS);

    visiveis.forEach(item => {
      const tr = document.createElement("tr");

      const tdData = document.createElement("td");
      tdData.textContent = item.dataBR || formatarDataBR(item.dataISO);

      const tdPessoas = document.createElement("td");
      tdPessoas.textContent = Array.isArray(item.pessoas) ? item.pessoas.join(", ") : "";

      const tdAcoes = document.createElement("td");
      tdAcoes.className = "row-actions";

      const btnEditar = document.createElement("button");
      btnEditar.className = "btn secondary small";
      btnEditar.type = "button";
      btnEditar.textContent = "Editar";
      btnEditar.onclick = () => {
        document.getElementById("dataDia").value = item.dataISO || hojeISO();
        selecaoDiaria = Array.isArray(item.pessoas) ? [...item.pessoas] : [];
        renderChipsDiario();
        document.getElementById("cardPresenca")?.scrollIntoView({ behavior:"smooth", block:"start" });
      };
      tdAcoes.appendChild(btnEditar);

      if(isAdmin){
        const btnExcluir = document.createElement("button");
        btnExcluir.className = "btn danger small";
        btnExcluir.type = "button";
        btnExcluir.textContent = "Excluir";
        btnExcluir.onclick = async () => {
          if(!confirm(`Excluir o dia ${item.dataBR || item.dataISO}?`)) return;
          await refDiarios.doc(item.dataISO).delete();
        };
        tdAcoes.appendChild(btnExcluir);
      }

      tr.appendChild(tdData);
      tr.appendChild(tdPessoas);
      tr.appendChild(tdAcoes);

      tbody.appendChild(tr);
    });

    atualizarBotaoVerMais();
  }

  function atualizarBotaoVerMais(){
    const btn = document.getElementById("btnVerMais");
    if(!btn) return;
    btn.style.display = LISTA.length > LIMITE_REGISTROS ? "inline-block" : "none";
    btn.textContent = mostrarTodosRegistros ? "Ver menos" : "Ver mais registros";
  }

  function toggleVerMais(){
    mostrarTodosRegistros = !mostrarTodosRegistros;
    carregarDiario();
  }
  window.toggleVerMais = toggleVerMais;

  async function apagarDiarios(){
    if(!isAdmin) return alert("Somente gestor pode apagar tudo.");
    if(!confirm("Tem certeza que deseja apagar TODOS os di√°rios deste contrato?")) return;

    const snap = await refDiarios.get();
    const batch = db.batch();
    snap.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("Todos os di√°rios foram apagados.");
  }
  window.apagarDiarios = apagarDiarios;

  function exportarDiarioCSV(){
    const header = ["Data", "Pessoas"];
    const linhas = [...LISTA]
      .sort((a,b)=> (a.dataISO||"").localeCompare(b.dataISO||""))
      .map(item => {
        const data = item.dataBR || formatarDataBR(item.dataISO);
        const pessoas = Array.isArray(item.pessoas) ? item.pessoas.join(" | ") : "";
        return [`"${data}"`, `"${pessoas.replaceAll('"','""')}"`].join(",");
      });

    const csv = [header.join(","), ...linhas].join("\n");
    const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `diario_${contratoAtual}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  window.exportarDiarioCSV = exportarDiarioCSV;

  // ===================== PTA (m√≠nimo) =====================
  function carregarPTA(){
    const tbody = document.getElementById("tabelaPTA");
    if(!tbody) return;

    tbody.innerHTML = "";

    const dados = [...PTA_LISTA];
    const visiveis = mostrarTodosPTA ? dados : dados.slice(0, LIMITE_PTA);

    visiveis.forEach(item => {
      const tr = document.createElement("tr");
      const cols = [
        item.dataISO ? formatarDataBR(item.dataISO) : "",
        item.condutor || "",
        item.kmIni ?? "",
        item.kmFim ?? "",
        item.local || "",
        item.desc || "",
        item.assinatura ? "OK" : ""
      ];
      cols.forEach(v => {
        const td = document.createElement("td");
        td.textContent = String(v);
        tr.appendChild(td);
      });

      const tdA = document.createElement("td");
      tdA.className = "row-actions";
      if(isAdmin){
        const b = document.createElement("button");
        b.className = "btn danger small";
        b.type = "button";
        b.textContent = "Excluir";
        b.onclick = async () => {
          if(!confirm("Excluir este registro PTA?")) return;
          await refPTA.doc(item.id).delete();
        };
        tdA.appendChild(b);
      } else tdA.textContent = "‚Äî";

      tr.appendChild(tdA);
      tbody.appendChild(tr);
    });

    const btn = document.getElementById("btnVerMaisPTA");
    if(btn){
      btn.style.display = PTA_LISTA.length > LIMITE_PTA ? "inline-block" : "none";
      btn.textContent = mostrarTodosPTA ? "Ver menos" : "Ver mais registros";
    }
  }

  function toggleVerMaisPTA(){
    mostrarTodosPTA = !mostrarTodosPTA;
    carregarPTA();
  }
  window.toggleVerMaisPTA = toggleVerMaisPTA;

  function salvarPTA(){ alert("Fun√ß√£o salvarPTA n√£o foi implementada nesta vers√£o m√≠nima."); }
  function limparPTA(){}
  window.salvarPTA = salvarPTA;
  window.limparPTA = limparPTA;

  // ===================== PAINEL / M√äS / PDF =====================
  function carregarMes(sel, itensMes){
    const tbody = document.getElementById("tabelaMes");
    if(tbody){
      tbody.innerHTML = "";
      const vis = mostrarTodosMes ? itensMes : itensMes.slice(0, LIMITE_MES);
      vis.forEach(item => {
        const tr = document.createElement("tr");
        const tdD = document.createElement("td");
        tdD.textContent = item.dataBR || formatarDataBR(item.dataISO);
        const tdP = document.createElement("td");
        tdP.textContent = Array.isArray(item.pessoas) ? item.pessoas.join(", ") : "";
        tr.appendChild(tdD);
        tr.appendChild(tdP);
        tbody.appendChild(tr);
      });

      const btn = document.getElementById("btnVerMaisMes");
      if(btn){
        btn.style.display = itensMes.length > LIMITE_MES ? "inline-block" : "none";
        btn.textContent = mostrarTodosMes ? "Ver menos registros" : "Ver mais registros";
      }
    }

    // PRINT M√äS
    const pMes = document.getElementById("printMes");
    if(pMes){
      pMes.innerHTML = "";
      itensMes.forEach(item => {
        const tr = document.createElement("tr");
        const tdD = document.createElement("td");
        tdD.textContent = item.dataBR || formatarDataBR(item.dataISO);
        const tdP = document.createElement("td");
        tdP.textContent = Array.isArray(item.pessoas) ? item.pessoas.join(", ") : "";
        tr.appendChild(tdD);
        tr.appendChild(tdP);
        pMes.appendChild(tr);
      });
    }
  }

  function toggleVerMaisMes(){
    mostrarTodosMes = !mostrarTodosMes;
    atualizarPainel();
  }
  window.toggleVerMaisMes = toggleVerMaisMes;

  function atualizarPainel(){
    const sel = getMesAnoSelecionado();
    if(!sel){
      const hoje = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      document.getElementById("mesAno").value = `${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}`;
      return;
    }

    document.getElementById("reportContrato").textContent = nomeContratoBonito(contratoAtual);
    const mesBR = `${sel.m}/${sel.y}`;
    document.getElementById("reportPeriodo").innerText = `Per√≠odo: ${mesBR}`;
    document.getElementById("reportGeradoEm").innerText = `Gerado em: ${agoraBR()}`;

    if(contratoAtual !== "ferroport"){
      document.getElementById("kpiDias").textContent = String(PTA_LISTA.length);
      document.getElementById("kpiPresencas").textContent = String(PTA_LISTA.length);
      document.getElementById("kpiTecnicos").textContent = String(new Set(PTA_LISTA.map(x => x.condutor).filter(Boolean)).size);
      return;
    }

    // itens do m√™s
    const itensMes = [...LISTA]
      .filter(x => inMesAno(x.dataISO, sel.y, sel.m))
      .sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));

    const dias = itensMes.length;
    const presencas = itensMes.reduce((acc, x)=> acc + (Array.isArray(x.pessoas) ? x.pessoas.length : 0), 0);

    const setTec = new Set();
    itensMes.forEach(x => (x.pessoas||[]).forEach(p => setTec.add(p)));

    document.getElementById("kpiDias").textContent = String(dias);
    document.getElementById("kpiPresencas").textContent = String(presencas);
    document.getElementById("kpiTecnicos").textContent = String(setTec.size);

    // tabela m√™s + print
    carregarMes(sel, itensMes);

    // ranking
    const ranking = contarDiasPorTecnico(itensMes);

    const tbodyRank = document.getElementById("tabelaRanking");
    if(tbodyRank){
      tbodyRank.innerHTML = "";
      const top10 = ranking.slice(0,10);
      const maxDias = Math.max(...top10.map(x => x.dias), 1);

      top10.forEach((r, idx) => {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td"); td1.textContent = String(idx + 1);
        const td2 = document.createElement("td"); td2.textContent = r.nome;
        const td3 = document.createElement("td"); td3.textContent = String(r.dias);

        const td4 = document.createElement("td");
        td4.innerHTML = `<div class="bar"><div class="bar-fill" style="width:${Math.round((r.dias/maxDias)*100)}%"></div></div>`;

        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
        tbodyRank.appendChild(tr);
      });
    }

    // PRINT RANKING
    const pRank = document.getElementById("printRanking");
    if(pRank){
      pRank.innerHTML = "";
      ranking.slice(0, 30).forEach((r, idx) => {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td"); td1.textContent = String(idx + 1);
        const td2 = document.createElement("td"); td2.textContent = r.nome;
        const td3 = document.createElement("td"); td3.textContent = String(r.dias);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
        pRank.appendChild(tr);
      });
    }

    // insights
    const top1 = ranking[0] || { nome:"‚Äî", dias:0 };
    document.getElementById("insightTopNome").textContent = top1.nome;
    document.getElementById("insightTopDias").textContent = String(top1.dias);
    document.getElementById("insightMediaDia").textContent = String(dias ? (presencas / dias).toFixed(1) : 0);
    document.getElementById("insightMediaTec").textContent = String(ranking.length ? (dias / ranking.length).toFixed(1) : 0);

    // gr√°fico
    desenharGraficoTop10("chartRanking", ranking);
  }
  window.atualizarPainel = atualizarPainel;

  function gerarPDF(){
    atualizarPainel();
    setTimeout(()=> window.print(), 50);
  }
  window.gerarPDF = gerarPDF;

  function initUI(){
    const selContrato = document.getElementById("contratoSelect");
    selContrato.addEventListener("change", ()=> setContrato(selContrato.value));

    document.getElementById("dataDia").value = hojeISO();

    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    document.getElementById("mesAno").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    document.getElementById("mesAno").addEventListener("change", atualizarPainel);

    mostrarBlocosContrato();

    window.addEventListener("resize", () => { try{ atualizarPainel(); }catch(_){ } });
  }

  auth.onAuthStateChanged(async (user) => {
    const msg = document.getElementById("loginMsg");

    if(!user){
      mostrarApp(false);
      desligarRealtime();
      const status = document.getElementById("loginStatus");
      if(status) status.style.display = "none";
      const btn = document.getElementById("btnEntrar");
      if(btn) btn.disabled = false;
      return;
    }

    try{
      await carregarPermissoesUsuario(user);

      if(!allowedContracts.length){
        mostrarApp(false);
        if(msg) msg.textContent = "Seu usu√°rio n√£o tem acesso a nenhum contrato. Pe√ßa libera√ß√£o ao gestor.";
        await auth.signOut();
        return;
      }

      montarSelectContratos();

      document.getElementById("userBadge").textContent = `Logado como: ${user.email || "‚Äî"}`;
      aplicarPermissoesUI();
      mostrarApp(true);

      setRefsContrato();
      ligarRealtime();
      initUI();

      // garante um draw inicial
      setTimeout(() => atualizarPainel(), 50);
    }catch(e){
      mostrarApp(false);
      if(msg) msg.textContent = "Erro ao carregar permiss√µes (Rules / users). Abra o console (F12).";
      console.error(e);
      await auth.signOut();
    }
  });

  setRefsContrato();
</script>
