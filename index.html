<script>
(function(){
  // ====== FAILSAFE: nunca mais tela branca sem mensagem ======
  function showFatal(err){
    console.error(err);
    document.body.innerHTML =
      '<div style="font-family:Arial;padding:20px">' +
      '<h2 style="color:#CB3344">Erro no JavaScript (tela branca)</h2>' +
      '<pre style="background:#111;color:#0f0;padding:12px;border-radius:8px;white-space:pre-wrap">' +
      (err && (err.stack || err.message) ? (err.stack || err.message) : String(err)) +
      '</pre>' +
      '<p>Abra o Console (F12) para mais detalhes.</p>' +
      '</div>';
  }
  window.addEventListener("error", (e)=> showFatal(e.error || e.message));
  window.addEventListener("unhandledrejection", (e)=> showFatal(e.reason));

  // ====== Rode sÃ³ depois do DOM existir ======
  document.addEventListener("DOMContentLoaded", main);

  function main(){
    try{
      // ====== Confere se Firebase carregou ======
      if(typeof firebase === "undefined"){
        throw new Error("firebase is not defined. Verifique se os 3 scripts compat do Firebase estÃ£o acima deste script.");
      }

      // ===================== CONFIG =====================
      const firebaseConfig = {
        apiKey: "AIzaSyBzgChouE4W25XnD-vFybJrKVN9yl3R0IQ",
        authDomain: "ferroportluannogueira.firebaseapp.com",
        projectId: "ferroportluannogueira",
        storageBucket: "ferroportluannogueira.firebasestorage.app",
        messagingSenderId: "531699539518",
        appId: "1:531699539518:web:6e32a169d9110f70b9fb6f",
        measurementId: "G-61BRVCSHD7"
      };

      const CONTRATOS = [
        { value: "ferroport",  label: "Ferroport" },
        { value: "pta-inveco", label: "PTA INVECO" }
      ];

      // âœ… evita erro "already exists"
      if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const db   = firebase.firestore();

      // ===================== ESTADO =====================
      let LISTA = [];
      let NOMES = [];
      let selecaoDiaria = [];

      let PTA_LISTA = [];
      let mostrarTodosPTA = false;
      const LIMITE_PTA = 6;

      let mostrarTodosRegistros = false;
      const LIMITE_REGISTROS = 5;

      let mostrarTodosMes = false;
      const LIMITE_MES = 6;

      const KEY_CONTRATO = "contrato_atual";
      let contratoAtual = localStorage.getItem(KEY_CONTRATO) || "ferroport";

      let allowedContracts = [];
      let isAdmin = false;

      let refDiarios = null;
      let refNomes = null;
      let refPTA = null;

      let unsubDiarios = null;
      let unsubNomes = null;
      let unsubPTA = null;

      // ===================== HELPERS =====================
      const $ = (id)=> document.getElementById(id);

      function formatarDataBR(dataISO){
        if(!dataISO) return "";
        const [y,m,d] = dataISO.split("-");
        return `${d}/${m}/${y}`;
      }
      function hojeISO(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      }
      function agoraBR(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function getMesAnoSelecionado(){
        const v = $("mesAno")?.value;
        if(!v) return null;
        const [y,m] = v.split("-");
        return { y, m };
      }
      function idSeguro(str){
        return String(str || "")
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
          .replace(/\s+/g,"-")
          .replace(/[^a-z0-9\-]/g,"")
          .slice(0,80);
      }
      function nomeContratoBonito(slug){
        return ({ "ferroport":"Ferroport", "pta-inveco":"PTA INVECO" }[slug] || slug);
      }
      function inMesAno(dataISO, y, m){
        if(!dataISO) return false;
        return dataISO.startsWith(`${y}-${m}-`);
      }

      // ===================== TEMA =====================
      const KEY_TEMA = "tema_site";
      function aplicarTema(theme){
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(KEY_TEMA, theme);
        const txt = theme === "dark" ? "â˜€ï¸ Tema" : "ðŸŒ™ Tema";
        if($("btnTema")) $("btnTema").textContent = txt;
        if($("btnTemaLogin")) $("btnTemaLogin").textContent = txt;
        try{ setTimeout(() => atualizarPainel(), 10); }catch(_){}
      }
      function toggleTema(){
        const atual = document.documentElement.getAttribute("data-theme") || "light";
        aplicarTema(atual === "dark" ? "light" : "dark");
      }
      window.toggleTema = toggleTema;

      aplicarTema(localStorage.getItem(KEY_TEMA) || "light");

      // ===================== SENHA =====================
      function toggleSenha(inputId, btn){
        const input = $(inputId);
        if(!input || !btn) return;
        const mostrando = input.type === "text";
        input.type = mostrando ? "password" : "text";
        const closed = btn.querySelector(".cam-closed");
        const open = btn.querySelector(".cam-open");
        if(closed && open){
          closed.style.display = mostrando ? "inline-flex" : "none";
          open.style.display = mostrando ? "none" : "inline-flex";
        }
      }
      window.toggleSenha = toggleSenha;

      // ===================== GRÃFICO =====================
      function contarDiasPorTecnico(itensMes){
        const map = new Map();
        itensMes.forEach(item => {
          (item.pessoas || []).forEach(nome => {
            map.set(nome, (map.get(nome) || 0) + 1);
          });
        });
        return [...map.entries()]
          .map(([nome, dias]) => ({ nome, dias }))
          .sort((a,b) => b.dias - a.dias || a.nome.localeCompare(b.nome, "pt-BR"));
      }

      function desenharGraficoTop10(canvasId, data){
        const canvas = $(canvasId);
        if(!canvas) return;

        const w = canvas.clientWidth || 0;
        const h = canvas.clientHeight || 0;
        if(w < 50 || h < 50) return;

        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);

        const ctx = canvas.getContext("2d");
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,w,h);

        if(!data || data.length === 0){
          ctx.font = "14px Arial";
          ctx.fillStyle = "#888";
          ctx.fillText("Sem dados no mÃªs selecionado.", 12, 24);
          return;
        }

        const top = data.slice(0,10);
        const max = Math.max(...top.map(x => x.dias), 1);

        const padL = 150, padR = 18, padT = 18, padB = 18;
        const plotW = w - padL - padR;
        const rowH = Math.max(24, Math.floor((h - padT - padB) / top.length));
        const barH = Math.floor(rowH * 0.55);

        const styles = getComputedStyle(document.documentElement);
        const text = styles.getPropertyValue("--text").trim() || "#111";
        const muted = styles.getPropertyValue("--muted").trim() || "#666";
        const border = styles.getPropertyValue("--border").trim() || "#ddd";
        const bar = styles.getPropertyValue("--digital-red").trim() || "#CB3344";

        ctx.strokeStyle = border;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padL, padT);
        ctx.lineTo(padL, h - padB);
        ctx.stroke();

        ctx.font = "12px Arial";
        ctx.textBaseline = "middle";

        top.forEach((item, i) => {
          const y = padT + i * rowH + rowH/2;

          ctx.fillStyle = muted;
          const nome = item.nome.length > 22 ? item.nome.slice(0,22) + "â€¦" : item.nome;
          ctx.fillText(nome, 12, y);

          const bw = Math.max(2, (item.dias / max) * plotW);
          const x0 = padL;
          const y0 = Math.round(y - barH/2);

          ctx.fillStyle = bar;
          ctx.fillRect(x0, y0, bw, barH);

          ctx.fillStyle = text;
          ctx.fillText(String(item.dias), x0 + bw + 8, y);
        });
      }

      // ===================== PERMISSÃ•ES =====================
      async function carregarPermissoesUsuario(user){
        const snap = await db.collection("users").doc(user.uid).get();
        const data = snap.exists ? (snap.data() || {}) : {};
        allowedContracts = Array.isArray(data.allowedContracts) ? data.allowedContracts : [];
        isAdmin = String(data.role || "").toLowerCase() === "gestor";
      }

      function montarSelectContratos(){
        const sel = $("contratoSelect");
        if(!sel) return;

        sel.innerHTML = "";

        if(!allowedContracts.length){
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sem acesso";
          sel.appendChild(opt);
          sel.disabled = true;
          return;
        }

        sel.disabled = false;

        CONTRATOS
          .filter(c => allowedContracts.includes(c.value))
          .forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.value;
            opt.textContent = c.label;
            sel.appendChild(opt);
          });

        if(!allowedContracts.includes(contratoAtual)){
          contratoAtual = allowedContracts[0];
          localStorage.setItem(KEY_CONTRATO, contratoAtual);
        }

        sel.value = contratoAtual;
      }

      // ===================== REFS / REALTIME =====================
      function setRefsContrato(){
        refDiarios = db.collection("contratos").doc(contratoAtual).collection("diarios");
        refNomes   = db.collection("contratos").doc(contratoAtual).collection("nomes");
        refPTA     = db.collection("contratos").doc(contratoAtual).collection("ptauso");
      }

      function desligarRealtime(){
        if(typeof unsubDiarios === "function") unsubDiarios();
        if(typeof unsubNomes === "function") unsubNomes();
        if(typeof unsubPTA === "function") unsubPTA();
        unsubDiarios = unsubNomes = unsubPTA = null;
      }

      function ligarRealtime(){
        desligarRealtime();

        unsubDiarios = refDiarios.onSnapshot(
          (snap) => {
            LISTA = snap.docs.map(d => d.data());
            carregarDiario();
            atualizarPainel();
          },
          (err) => alert("Erro diÃ¡rios: " + (err?.message || err))
        );

        unsubNomes = refNomes.onSnapshot(
          (snap) => {
            NOMES = snap.docs.map(d => (d.data()||{}).nome).filter(Boolean).sort((a,b)=>a.localeCompare(b,"pt-BR"));
            renderChipsDiario();
          },
          (err) => alert("Erro nomes: " + (err?.message || err))
        );

        unsubPTA = refPTA.onSnapshot(
          (snap) => {
            PTA_LISTA = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));
            carregarPTA();
            atualizarPainel();
          },
          (err) => console.error("Erro PTA:", err)
        );
      }

      function mostrarBlocosContrato(){
        const isPTA = contratoAtual === "pta-inveco";
        if($("blocoPTA")) $("blocoPTA").style.display = isPTA ? "block" : "none";
        if($("blocoFerroport")) $("blocoFerroport").style.display = isPTA ? "none" : "block";
        if($("cardPresenca")) $("cardPresenca").style.display = isPTA ? "none" : "block";
        if($("cardListaFerroport")) $("cardListaFerroport").style.display = isPTA ? "none" : "block";
        if($("printPTA")) $("printPTA").style.display = isPTA ? "block" : "none";
        if($("printFerroport")) $("printFerroport").style.display = isPTA ? "none" : "block";
      }

      function setContrato(novo){
        if(!allowedContracts.includes(novo)){
          alert("VocÃª nÃ£o tem permissÃ£o para acessar este contrato.");
          if($("contratoSelect")) $("contratoSelect").value = contratoAtual;
          return;
        }

        contratoAtual = novo;
        localStorage.setItem(KEY_CONTRATO, contratoAtual);

        setRefsContrato();
        ligarRealtime();

        selecaoDiaria = [];
        renderChipsDiario();
        limparDiario(true);

        mostrarTodosMes = false;
        mostrarTodosRegistros = false;
        mostrarTodosPTA = false;

        mostrarBlocosContrato();
        atualizarPainel();
      }

      // ===================== UI LOGIN/APP =====================
      function mostrarApp(logado){
        if($("loginBox")) $("loginBox").style.display = logado ? "none" : "flex";
        if($("appRoot")) $("appRoot").style.display = logado ? "block" : "none";
      }

      function aplicarPermissoesUI(){
        if($("rolePill")){
          $("rolePill").textContent = isAdmin ? "Gestor" : "TÃ©cnico";
          $("rolePill").classList.toggle("admin", isAdmin);
        }
        if($("btnApagarTudo")) $("btnApagarTudo").style.display = isAdmin ? "inline-block" : "none";
        if($("permMsg")) $("permMsg").style.display = isAdmin ? "none" : "block";
      }

      // ===================== CHIPS / NOMES =====================
      function renderChipsDiario(){
        const wrap = $("chipsDiario");
        if(!wrap) return;
        wrap.innerHTML = "";

        NOMES.forEach(nome => {
          const box = document.createElement("div");
          box.className = "chip-box";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
          btn.innerText = nome;

          btn.onclick = () => {
            selecaoDiaria = selecaoDiaria.includes(nome)
              ? selecaoDiaria.filter(n => n !== nome)
              : [...selecaoDiaria, nome];
            renderChipsDiario();
          };

          const remover = document.createElement("span");
          remover.className = "remove";
          remover.title = "Excluir nome (gestor)";
          remover.innerText = "âœ–";
          remover.style.display = isAdmin ? "inline-flex" : "none";
          remover.onclick = (e) => { e.stopPropagation(); excluirNome(nome); };

          box.appendChild(btn);
          box.appendChild(remover);
          wrap.appendChild(box);
        });
      }
      window.renderChipsDiario = renderChipsDiario;

      async function adicionarNome(){
        const input = $("novoNome");
        const nome = input?.value.trim();
        if(!nome) return alert("Digite um nome.");

        const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
        if(existe) return alert("Esse nome jÃ¡ existe.");

        await refNomes.doc(idSeguro(nome)).set({ nome });
        input.value = "";
      }
      window.adicionarNome = adicionarNome;

      async function excluirNome(nome){
        if(!isAdmin) return alert("Somente gestor pode excluir nomes.");
        if(!confirm(`Deseja excluir "${nome}"?`)) return;
        await refNomes.doc(idSeguro(nome)).delete();
        selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
      }

      // ===================== DIÃRIOS =====================
      async function salvarDiario(){
        const data = $("dataDia")?.value;
        if(!data) return alert("Selecione a data.");
        if(selecaoDiaria.length === 0) return alert("Selecione pelo menos uma pessoa.");

        const item = { dataISO: data, dataBR: formatarDataBR(data), pessoas: [...selecaoDiaria] };
        await refDiarios.doc(data).set(item);
        limparDiario();
      }
      window.salvarDiario = salvarDiario;

      function limparDiario(silencioso=false){
        if($("dataDia")) $("dataDia").value = hojeISO();
        selecaoDiaria = [];
        renderChipsDiario();
        if(!silencioso && $("novoNome")) $("novoNome").value = "";
      }
      window.limparDiario = limparDiario;

      function carregarDiario(){
        const tbody = $("tabelaDiario");
        if(!tbody) return;

        tbody.innerHTML = "";
        const dados = [...LISTA].sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));
        const visiveis = mostrarTodosRegistros ? dados : dados.slice(0, LIMITE_REGISTROS);

        visiveis.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.dataBR || formatarDataBR(item.dataISO)}</td>
            <td>${Array.isArray(item.pessoas) ? item.pessoas.join(", ") : ""}</td>
            <td class="row-actions">
              <button class="btn secondary small" type="button">Editar</button>
              ${isAdmin ? '<button class="btn danger small" type="button">Excluir</button>' : ''}
            </td>
          `;

          const btns = tr.querySelectorAll("button");
          btns[0].onclick = () => {
            if($("dataDia")) $("dataDia").value = item.dataISO || hojeISO();
            selecaoDiaria = Array.isArray(item.pessoas) ? [...item.pessoas] : [];
            renderChipsDiario();
            $("cardPresenca")?.scrollIntoView({ behavior:"smooth", block:"start" });
          };

          if(isAdmin && btns[1]){
            btns[1].onclick = async () => {
              if(!confirm(`Excluir o dia ${item.dataBR || item.dataISO}?`)) return;
              await refDiarios.doc(item.dataISO).delete();
            };
          }

          tbody.appendChild(tr);
        });

        atualizarBotaoVerMais();
      }

      function atualizarBotaoVerMais(){
        const btn = $("btnVerMais");
        if(!btn) return;
        btn.style.display = LISTA.length > LIMITE_REGISTROS ? "inline-block" : "none";
        btn.textContent = mostrarTodosRegistros ? "Ver menos" : "Ver mais registros";
      }

      function toggleVerMais(){
        mostrarTodosRegistros = !mostrarTodosRegistros;
        carregarDiario();
      }
      window.toggleVerMais = toggleVerMais;

      async function apagarDiarios(){
        if(!isAdmin) return alert("Somente gestor pode apagar tudo.");
        if(!confirm("Tem certeza que deseja apagar TODOS os diÃ¡rios deste contrato?")) return;

        const snap = await refDiarios.get();
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("Todos os diÃ¡rios foram apagados.");
      }
      window.apagarDiarios = apagarDiarios;

      function exportarDiarioCSV(){
        const header = ["Data", "Pessoas"];
        const linhas = [...LISTA]
          .sort((a,b)=> (a.dataISO||"").localeCompare(b.dataISO||""))
          .map(item => {
            const data = item.dataBR || formatarDataBR(item.dataISO);
            const pessoas = Array.isArray(item.pessoas) ? item.pessoas.join(" | ") : "";
            return [`"${data}"`, `"${pessoas.replaceAll('"','""')}"`].join(",");
          });

        const csv = [header.join(","), ...linhas].join("\n");
        const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `diario_${contratoAtual}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      window.exportarDiarioCSV = exportarDiarioCSV;

      // ===================== PTA (stubs para nÃ£o quebrar) =====================
      function carregarPTA(){
        const tbody = $("tabelaPTA");
        if(!tbody) return;
        tbody.innerHTML = "";
      }
      function toggleVerMaisPTA(){ mostrarTodosPTA = !mostrarTodosPTA; carregarPTA(); }
      window.toggleVerMaisPTA = toggleVerMaisPTA;

      window.salvarPTA = ()=> alert("salvarPTA() ainda nÃ£o implementado.");
      window.limparPTA = ()=> {};
      window.limparAssinatura = ()=> {};

      // ===================== MÃŠS / PAINEL =====================
      function carregarMes(itensMes){
        const tbody = $("tabelaMes");
        if(!tbody) return;

        tbody.innerHTML = "";
        const vis = mostrarTodosMes ? itensMes : itensMes.slice(0, LIMITE_MES);

        vis.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.dataBR || formatarDataBR(item.dataISO)}</td>
            <td>${Array.isArray(item.pessoas) ? item.pessoas.join(", ") : ""}</td>
          `;
          tbody.appendChild(tr);
        });

        const btn = $("btnVerMaisMes");
        if(btn){
          btn.style.display = itensMes.length > LIMITE_MES ? "inline-block" : "none";
          btn.textContent = mostrarTodosMes ? "Ver menos registros" : "Ver mais registros";
        }

        const pMes = $("printMes");
        if(pMes){
          pMes.innerHTML = "";
          itensMes.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${item.dataBR || formatarDataBR(item.dataISO)}</td>
              <td>${Array.isArray(item.pessoas) ? item.pessoas.join(", ") : ""}</td>
            `;
            pMes.appendChild(tr);
          });
        }
      }

      function toggleVerMaisMes(){ mostrarTodosMes = !mostrarTodosMes; atualizarPainel(); }
      window.toggleVerMaisMes = toggleVerMaisMes;

      function atualizarPainel(){
        const sel = getMesAnoSelecionado();
        if(!sel){
          const hoje = new Date();
          const pad = (n)=> String(n).padStart(2,"0");
          if($("mesAno")) $("mesAno").value = `${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}`;
          return;
        }

        if($("reportContrato")) $("reportContrato").textContent = nomeContratoBonito(contratoAtual);
        if($("reportPeriodo")) $("reportPeriodo").innerText = `PerÃ­odo: ${sel.m}/${sel.y}`;
        if($("reportGeradoEm")) $("reportGeradoEm").innerText = `Gerado em: ${agoraBR()}`;

        if(contratoAtual !== "ferroport") return;

        const itensMes = [...LISTA]
          .filter(x => inMesAno(x.dataISO, sel.y, sel.m))
          .sort((a,b)=> (b.dataISO||"").localeCompare(a.dataISO||""));

        const dias = itensMes.length;
        const presencas = itensMes.reduce((acc, x)=> acc + (Array.isArray(x.pessoas) ? x.pessoas.length : 0), 0);
        const setTec = new Set();
        itensMes.forEach(x => (x.pessoas||[]).forEach(p => setTec.add(p)));

        if($("kpiDias")) $("kpiDias").textContent = String(dias);
        if($("kpiPresencas")) $("kpiPresencas").textContent = String(presencas);
        if($("kpiTecnicos")) $("kpiTecnicos").textContent = String(setTec.size);

        carregarMes(itensMes);

        const ranking = contarDiasPorTecnico(itensMes);

        const tbodyRank = $("tabelaRanking");
        if(tbodyRank){
          tbodyRank.innerHTML = "";
          const top10 = ranking.slice(0,10);
          const maxDias = Math.max(...top10.map(x => x.dias), 1);

          top10.forEach((r, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${idx+1}</td>
              <td>${r.nome}</td>
              <td>${r.dias}</td>
              <td><div class="bar"><div class="bar-fill" style="width:${Math.round((r.dias/maxDias)*100)}%"></div></div></td>
            `;
            tbodyRank.appendChild(tr);
          });
        }

        if($("insightTopNome")) $("insightTopNome").textContent = (ranking[0]?.nome || "â€”");
        if($("insightTopDias")) $("insightTopDias").textContent = String(ranking[0]?.dias || 0);
        if($("insightMediaDia")) $("insightMediaDia").textContent = String(dias ? (presencas/dias).toFixed(1) : 0);
        if($("insightMediaTec")) $("insightMediaTec").textContent = String(ranking.length ? (dias/ranking.length).toFixed(1) : 0);

        desenharGraficoTop10("chartRanking", ranking);
      }
      window.atualizarPainel = atualizarPainel;

      function gerarPDF(){ atualizarPainel(); setTimeout(()=> window.print(), 50); }
      window.gerarPDF = gerarPDF;

      // ===================== LOGIN =====================
      async function login(){
        const email = $("loginEmail")?.value.trim();
        const senha = $("loginSenha")?.value.trim();
        const msg = $("loginMsg");
        const status = $("loginStatus");
        const btn = $("btnEntrar");

        if(msg) msg.textContent = "";
        if(status) status.style.display = "flex";
        if(btn) btn.disabled = true;

        try{
          await auth.signInWithEmailAndPassword(email, senha);
        }catch(e){
          if(msg) msg.textContent = "Falha no login: " + (e?.code || e?.message || e);
          if(status) status.style.display = "none";
          if(btn) btn.disabled = false;
        }
      }
      window.login = login;

      async function esqueciSenha(){
        const email = $("loginEmail")?.value.trim();
        const msg = $("loginMsg");
        if(msg) msg.textContent = "";

        if(!email){
          if(msg) msg.textContent = "Digite seu e-mail para receber o link de redefiniÃ§Ã£o.";
          return;
        }
        try{
          await auth.sendPasswordResetEmail(email);
          if(msg) msg.textContent = "Pronto! Enviamos um e-mail para redefinir sua senha.";
        }catch(e){
          if(msg) msg.textContent = "NÃ£o foi possÃ­vel enviar: " + (e?.code || e?.message || e);
        }
      }
      window.esqueciSenha = esqueciSenha;

      window.logout = async ()=> auth.signOut();

      // ===================== INIT UI =====================
      function initUI(){
        if($("contratoSelect")){
          $("contratoSelect").addEventListener("change", ()=> setContrato($("contratoSelect").value));
        }
        if($("dataDia")) $("dataDia").value = hojeISO();

        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        if($("mesAno")){
          $("mesAno").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
          $("mesAno").addEventListener("change", atualizarPainel);
        }

        mostrarBlocosContrato();
        window.addEventListener("resize", ()=> { try{ atualizarPainel(); }catch(_){} });
      }

      // ===================== AUTH STATE =====================
      setRefsContrato();

      auth.onAuthStateChanged(async (user) => {
        const msg = $("loginMsg");

        if(!user){
          mostrarApp(false);
          desligarRealtime();
          if($("loginStatus")) $("loginStatus").style.display = "none";
          if($("btnEntrar")) $("btnEntrar").disabled = false;
          return;
        }

        try{
          await carregarPermissoesUsuario(user);

          if(!allowedContracts.length){
            mostrarApp(false);
            if(msg) msg.textContent = "Seu usuÃ¡rio nÃ£o tem acesso a nenhum contrato. PeÃ§a liberaÃ§Ã£o ao gestor.";
            await auth.signOut();
            return;
          }

          montarSelectContratos();
          if($("userBadge")) $("userBadge").textContent = `Logado como: ${user.email || "â€”"}`;
          aplicarPermissoesUI();
          mostrarApp(true);

          setRefsContrato();
          ligarRealtime();
          initUI();

          setTimeout(()=> atualizarPainel(), 120);
        }catch(e){
          showFatal(e);
          await auth.signOut();
        }
      });

    }catch(err){
      showFatal(err);
    }
  }
})();
</script>
