<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PresenÃ§a diÃ¡ria â€” Ferroport</title>

  <!-- Ãcone da aba (opcional): coloque um arquivo favicon.png na pasta -->
  <link rel="icon" type="image/png" href="favicon.png">

  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header class="topbar">
  <div class="brand">

    <div class="logos">
      <img src="logo-digital.png" alt="Logo Digital" class="logo">
      <!-- EMIVE maior: precisa dessa classe "emive" -->
      <img src="logo-emive.png" alt="Logo Emive" class="logo emive">
    </div>

    <div class="brand-text">
      <div class="brand-title">PresenÃ§a diÃ¡ria â€” Ferroport</div>
      <div class="brand-subtitle">Controle de tÃ©cnicos no contrato</div>
    </div>

  </div>
</header>

<main class="container">

  <section class="card">
    <div class="card-head">
      <h2>PresenÃ§a por dia</h2>
      <p class="muted">Selecione a data e marque quem esteve no contrato.</p>
    </div>

    <div class="grid-2">
      <div class="field">
        <label>Data</label>
        <input id="dataDia" type="date" />
      </div>

      <div class="field">
        <label>Pessoas</label>

        <div class="chips" id="chipsDiario"></div>

        <div class="add-nome">
          <input type="text" id="novoNome" placeholder="Adicionar tÃ©cnico (ex: JoÃ£o Silva)">
          <button class="btn" type="button" onclick="adicionarNome()">+ Adicionar</button>
        </div>

        <p class="muted small">Os nomes ficam salvos no navegador.</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn" onclick="salvarDiario()">ðŸ’¾ Salvar dia</button>
      <button class="btn secondary" onclick="limparDiario()">ðŸ§¹ Limpar</button>
      <button class="btn danger" onclick="apagarDiarios()">ðŸ—‘ Apagar tudo</button>
      <button class="btn" onclick="exportarDiarioCSV()">â¬‡ Exportar CSV</button>
      <button class="btn" onclick="gerarRelatorio()">ðŸ“„ Gerar relatÃ³rio mensal</button>
    </div>
  </section>

  <section class="card">
    <div class="card-head">
      <h2>PresenÃ§as registradas</h2>
      <p class="muted">Se salvar a mesma data novamente, o sistema atualiza.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>TÃ©cnicos presentes</th>
        </tr>
      </thead>
      <tbody id="tabelaDiario"></tbody>
    </table>
  </section>

  <footer class="footer">
    DIGITAL â€¢ EMIVE â€¢ Tecnologia e SeguranÃ§a
  </footer>

</main>

<script>
  const KEY_DIARIOS = "presencas_diarias";
  const KEY_NOMES = "nomes_tecnicos";

  const NOMES_PADRAO = ["Luan Nogueira", "Lucas Gregorio", "Phillipe Carvalho"];
  let NOMES = JSON.parse(localStorage.getItem(KEY_NOMES)) || [...NOMES_PADRAO];

  let selecaoDiaria = [];

  function salvarNomes(){
    localStorage.setItem(KEY_NOMES, JSON.stringify(NOMES));
  }

  function formatarDataBR(dataISO){
    const [y,m,d] = dataISO.split("-");
    return `${d}/${m}/${y}`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  // Render dos nomes com botÃ£o de excluir
  function renderChipsDiario(){
    const wrap = document.getElementById("chipsDiario");
    wrap.innerHTML = "";

    NOMES.forEach(nome => {
      const box = document.createElement("div");
      box.className = "chip-box";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip" + (selecaoDiaria.includes(nome) ? " active" : "");
      btn.innerText = nome;

      btn.onclick = () => {
        if (selecaoDiaria.includes(nome)) {
          selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
        } else {
          selecaoDiaria.push(nome);
        }
        renderChipsDiario();
      };

      const remover = document.createElement("span");
      remover.className = "remove";
      remover.title = "Excluir nome";
      remover.innerText = "âœ–";

      remover.onclick = (e) => {
        e.stopPropagation();
        excluirNome(nome);
      };

      box.appendChild(btn);
      box.appendChild(remover);
      wrap.appendChild(box);
    });
  }

  function adicionarNome(){
    const input = document.getElementById("novoNome");
    const nome = input.value.trim();

    if(!nome){
      alert("Digite um nome.");
      return;
    }

    const existe = NOMES.some(n => n.toLowerCase() === nome.toLowerCase());
    if(existe){
      alert("Esse nome jÃ¡ existe.");
      return;
    }

    NOMES.push(nome);
    NOMES.sort((a,b) => a.localeCompare(b, "pt-BR"));
    salvarNomes();

    input.value = "";
    renderChipsDiario();
  }

  function excluirNome(nome){
    if(!confirm(`Deseja excluir "${nome}"?`)) return;

    NOMES = NOMES.filter(n => n !== nome);
    selecaoDiaria = selecaoDiaria.filter(n => n !== nome);
    salvarNomes();
    renderChipsDiario();
  }

  function salvarDiario(){
    const data = document.getElementById("dataDia").value;

    if(!data){
      alert("Selecione a data.");
      return;
    }

    if(selecaoDiaria.length === 0){
      alert("Selecione pelo menos uma pessoa.");
      return;
    }

    const item = {
      dataISO: data,
      dataBR: formatarDataBR(data),
      pessoas: [...selecaoDiaria]
    };

    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

    // Atualiza se jÃ¡ existir a data
    const idx = lista.findIndex(x => x.dataISO === data);
    if(idx >= 0) lista[idx] = item;
    else lista.push(item);

    // Ordena por data
    lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));

    localStorage.setItem(KEY_DIARIOS, JSON.stringify(lista));

    carregarDiario();
    limparDiario();
  }

  function carregarDiario(){
    const tbody = document.getElementById("tabelaDiario");
    tbody.innerHTML = "";

    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

    lista.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td><strong>${escapeHtml(r.dataBR)}</strong></td>
          <td>${(r.pessoas || []).map(escapeHtml).join("<br>")}</td>
        </tr>
      `;
    });
  }

  function limparDiario(){
    document.getElementById("dataDia").value = "";
    selecaoDiaria = [];
    renderChipsDiario();
  }

  function apagarDiarios(){
    if(confirm("Deseja apagar todos os registros?")){
      localStorage.removeItem(KEY_DIARIOS);
      carregarDiario();
    }
  }

  function exportarDiarioCSV(){
    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

    if(lista.length === 0){
      alert("NÃ£o hÃ¡ registros para exportar.");
      return;
    }

    let csv = "Data;Pessoas\n";
    lista.forEach(r => {
      csv += `${r.dataBR};"${(r.pessoas || []).join(", ")}"\n`;
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "presencas_ferroport.csv";
    link.click();
  }

  // RELATÃ“RIO BONITO (abre para imprimir/salvar PDF)
  function gerarRelatorio(){
    let lista = JSON.parse(localStorage.getItem(KEY_DIARIOS) || "[]");

    if(lista.length === 0){
      alert("NÃ£o hÃ¡ dados para gerar relatÃ³rio.");
      return;
    }

    // Ordena por data
    lista.sort((a,b) => a.dataISO.localeCompare(b.dataISO));

    const nomesMes = {
      "01":"Janeiro","02":"Fevereiro","03":"MarÃ§o","04":"Abril",
      "05":"Maio","06":"Junho","07":"Julho","08":"Agosto",
      "09":"Setembro","10":"Outubro","11":"Novembro","12":"Dezembro"
    };

    // filtra somente o mÃªs do primeiro item (relatÃ³rio mensal)
    const [ano, mes] = (lista[0].dataISO || "0000-00-00").split("-");
    const mesNome = nomesMes[mes] || "MÃªs";

    const listaMes = lista.filter(x => (x.dataISO || "").startsWith(`${ano}-${mes}`));

    // total por tÃ©cnico
    const totals = {};
    listaMes.forEach(r => {
      (r.pessoas || []).forEach(p => {
        totals[p] = (totals[p] || 0) + 1;
      });
    });

    let linhas = "";
    listaMes.forEach(r => {
      linhas += `
        <tr>
          <td>${escapeHtml(r.dataBR)}</td>
          <td>${(r.pessoas || []).map(escapeHtml).join(", ")}</td>
        </tr>
      `;
    });

    let resumo = "";
    const tecnicosOrdenados = Object.keys(totals).sort((a,b)=>a.localeCompare(b,"pt-BR"));
    tecnicosOrdenados.forEach(t => {
      resumo += `<li><strong>${escapeHtml(t)}</strong>: ${totals[t]} dia(s)</li>`;
    });

    const html = `
    <!doctype html>
    <html lang="pt-br">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>RelatÃ³rio Mensal â€” Ferroport</title>
      <style>
        :root{
          --text:#1E2328;
          --muted:#6B7280;
          --border:#E6E8EE;
          --red:#CB3344;
        }
        body{
          font-family: Arial, sans-serif;
          color: var(--text);
          margin: 0;
          padding: 36px;
        }
        .topo{
          display:flex;
          align-items:center;
          gap:18px;
          border-bottom:2px solid var(--border);
          padding-bottom:16px;
          margin-bottom:18px;
        }
        .logos{
          display:flex;
          align-items:center;
          gap:16px;
        }
        .logo{ height:58px; width:auto; object-fit:contain; }
        .logo.emive{ height:78px; }
        h1{ margin:0; font-size:20px; }
        .sub{ margin-top:4px; color:var(--muted); }
        .meta{
          margin-top:8px;
          display:flex;
          gap:18px;
          flex-wrap:wrap;
          color:var(--muted);
          font-size:13px;
        }
        .badge{
          display:inline-block;
          padding:6px 10px;
          border:1px solid var(--border);
          border-radius:999px;
          background:#fafafa;
        }
        table{
          width:100%;
          border-collapse:collapse;
          margin-top:14px;
        }
        th,td{
          border:1px solid var(--border);
          padding:10px;
          text-align:left;
          vertical-align:top;
          font-size:13px;
        }
        th{ background:#f3f4f6; text-align:center; }
        td:nth-child(1){ width:140px; text-align:center; }
        .grid{
          display:grid;
          grid-template-columns: 1.1fr 0.9fr;
          gap: 16px;
          margin-top: 14px;
        }
        .box{
          border:1px solid var(--border);
          border-radius:14px;
          padding:14px;
        }
        .box h2{
          margin:0 0 8px 0;
          font-size:14px;
        }
        ul{ margin:0; padding-left:18px; }
        .rodape{
          margin-top:22px;
          padding-top:12px;
          border-top:1px solid var(--border);
          text-align:center;
          color:var(--muted);
          font-size:12px;
        }
        .print-hint{
          margin-top:10px;
          color:var(--muted);
          font-size:12px;
        }
        @media print{
          .print-hint{ display:none; }
          body{ padding: 18px; }
        }
      </style>
    </head>
    <body>
      <div class="topo">
        <div class="logos">
          <img src="logo-digital.png" class="logo" alt="Digital">
          <img src="logo-emive.png" class="logo emive" alt="Emive">
        </div>
        <div>
          <h1>RelatÃ³rio Mensal de PresenÃ§a</h1>
          <div class="sub">Contrato: Ferroport</div>
          <div class="meta">
            <span class="badge"><strong>MÃªs:</strong> ${escapeHtml(mesNome)} / ${escapeHtml(ano)}</span>
            <span class="badge"><strong>Registros:</strong> ${listaMes.length}</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="box">
          <h2>PresenÃ§as por dia</h2>
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>TÃ©cnicos presentes</th>
              </tr>
            </thead>
            <tbody>
              ${linhas}
            </tbody>
          </table>
        </div>

        <div class="box">
          <h2>Resumo do mÃªs (dias por tÃ©cnico)</h2>
          <ul>
            ${resumo || "<li>Nenhum dado.</li>"}
          </ul>

          <div class="print-hint">
            Para gerar PDF: pressione <strong>Ctrl + P</strong> e selecione <strong>Salvar como PDF</strong>.
          </div>
        </div>
      </div>

      <div class="rodape">
        DIGITAL â€¢ EMIVE â€” Tecnologia e SeguranÃ§a
      </div>
    </body>
    </html>
    `;

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // Inicializa
  salvarNomes();
  renderChipsDiario();
  carregarDiario();
</script>

</body>
</html>
